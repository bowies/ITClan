<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="onebyone"> 

<!-- SELECT oneByOneNum, title,content, id,regdate, grpnum,indent,ansnum  -->
<select id="readReply" parameterType="int" resultType="OneByOneDTO">
SELECT oneByOneNum, title, id,regdate, grpnum,indent,ansnum 
FROM OneByOne                           
WHERE oneByOneNum = #{oneByOneNum}                 

</select>


<insert id="reply" parameterType="OneByOneDTO">  
INSERT INTO OneByOne(oneByOneNum , title, content, id, regdate, grpnum, indent, ansnum)
values((SELECT NVL(MAX(oneByOneNum), 0) + 1 as oneByOneNum FROM OneByOne),
#{title}, #{content}, #{id}, sysdate,
#{grpnum}, #{indent}+1, #{ansnum}+1)  
</insert>


<select id="checkId" parameterType="Map" resultType="int">
SELECT COUNT(oneByOneNum) as cnt
FROM OneByOne             
WHERE oneByOneNum= #{oneByOneNum} AND id=#{id}
</select>


<update id="increaseViewcnt" parameterType="int">
UPDATE OneByOne            
SET viewcnt = viewcnt + 1
WHERE oneByOneNum = #{oneByOneNum}       
</update>

<update id="addAnsnum" parameterType="Map">
UPDATE OneByOne           
SET ansnum = ansnum + 1  
WHERE grpnum=#{grpnum} AND ansnum > #{ansnum}

</update>


<insert id="create" parameterType="OneByOneDTO">
INSERT INTO OneByOne(oneByOneNum , title, content, mail, filename, id, regdate, grpnum)
values((SELECT NVL(MAX(oneByOneNum), 0) + 1 as oneByOneNum FROM OneByOne),
#{title}, #{content}, #{mail}, #{filename}, #{id}, sysdate,
(SELECT NVL(MAX(grpnum), 0) + 1 as grpnum FROM OneByOne))  
</insert>



<select id="list" resultType="OneByOneDTO" parameterType="Map">
	select oneByOneNum, id, mail, title,content,regdate, viewcnt, grpnum, ansnum, indent, r  
		from(                                                                  
			select oneByOneNum,  id, mail, title,content,regdate, viewcnt,  grpnum, ansnum, indent, rownum r 
			from(                                                                
			select oneByOneNum, id, mail, title,content,viewcnt, regdate  , grpnum, ansnum, indent
			from OneByOne                                                                                                              
            <where>
            <choose>
            <when test="col=='id'">
            id like '%'||#{word}||'%'
            </when>
            <when test="col=='mail'">
            mail like '%'||#{word}||'%'
            </when>
            <when test="col=='title'">
            title like '%'||#{word}||'%'
            </when>           
            <when test="col=='content'">
            content like '%'||#{word}||'%'
            </when>           
            </choose>      
            </where>                                                                 
         ORDER BY oneByOneNum desc                                            
        
        )
    )                                                                            
   <![CDATA[                                                                        
   where r>=#{sno} and r<=#{eno}  
   ]]>                                                           
  </select>



 <select id="read" resultType="OneByOneDTO" parameterType="int" >
 SELECT oneByOneNum, id, mail,name, title, content, filename, viewcnt, regdate
 FROM OneByOne            
  WHERE oneByOneNum = #{oneByOneNum}                                                              
 </select>
      

<update id="update" parameterType="OneByOneDTO">
UPDATE OneByOne                 
SET name=#{name}, title=#{title}, content=#{content}, filename=#{filename}  
WHERE oneByOneNum = #{oneByOneNum}             
</update>     
      
  
<delete id="delete" parameterType="int">
DELETE FROM OneByOne
WHERE oneByOneNum = #{oneByOneNum}
</delete>


<select id="total" parameterType="Map" resultType="int">
 select count(*) from OneByOne         
<where>
<choose>
	  <when test="col=='id'">
	   id like '%'||#{word}||'%'
	   </when>
	   <when test="col=='mail'">
	   mail like '%'||#{word}||'%'
	   </when>
	   <when test="col=='title'">
	   title like '%'||#{word}||'%'
	   </when>           
	   <when test="col=='content'">
	   content like '%'||#{word}||'%'
	   </when>        
</choose>
</where>       
</select>


</mapper>